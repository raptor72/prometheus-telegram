# prometheus-telegram

**prometheus-telegram** - бот для расширения возможностей системы Prometheus по оповещению пользователей о наступлении аварийных событий.

Бот выполняет две задачи:

1. Присылает оповещения об аварийных сообщениях из Prometheus пользователям в Telegram. 

2. Так как зачастую в качестве дашборда к Prometheus настраивается Grafana, 
бот дает возможность пользователю загружать скриншоты конкретных графиков из Grafana. 
Это позволяет удаленно получить визуализацию интересующих метрик.

Решение состоит из двух основных компонентов. 
 - Скрипта **bot.py** в котором описан класс Bot, отвечающий главным образом за взаимодействие с Telegram.
 - Точка входа программы - скрипт **main.py** запускающий сервер.

Помимо этого в проекте присутствует: 

 - конфигурационный файл - **exhample_config**
 - файл в котором храняться подписки пользователей на алармы - **users**
 - набор юнит-тестов **test_prometheus_telegram.py**
 - список зависимостей **requirements.txt**
 - файл для сборки докер-контейнера - **Dockerfile**

В main.py __main__ на входе принимаются 4 аргумента:

Класс Bot для взаимодействия с телеграм использует модуль pyTelegramBotAPI. 
Взаиможействие с пользователем происходит

 - порт'-p', '--port', action='store', type=int, default=8080)
 - хост '-H', '--host', action='store', type=str, default='127.0.0.1')
 - путь до конфигурационного файла '-c', '--config', action='store', type=str, default=DEFAULT_CONFIG)
 - путь до лог-файла '-l', '--log', action='store', default=None)

Наиболее интересен конфиг. Его проверяе функция check_config если файл будет составлен не верно 
функция вернет False и скрипт не запустится. Об этом будет сгенерировано соответствующее аварийное сообщение.
Если с конфигом все впорядке то запускается функция run.
При запуске данная функция создает обьект хранилище для алармов all_alarms, загружает конфиг-файл и инициализирует
экземпляр класса Bot. 

После функция связывает адрес и порт и начинает слушать буфер.
Далее методом os.fork() порождается дочерний процесс в котором запускается метод общения бота с телеграм bot.polling()
Этот метод состоит в периодической отправке запросов get_updates на сервера телеграм. В случае наличия обновления Telegram возвращает
ответ ответ с json,  который будет обрабатываться ботом.

В родительком процессе запускается чтение буфера функцией read_all()


В методе __init__ класс принимает конфиг в 
виде списка.
Помимо инита все остальные функции необходимы для интерактивного взаимодействия с пользователем для 
пересылки скриншотов из Gragana.
Наличие подключенной графаны не является обязательным, но делает функционал бота богаче. Для 




